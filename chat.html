<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #0a0a0f;
      color: #eaeaea;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    #navbar {
      background-color: #141421;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.7);
      z-index: 10;
    }

    #navbar a {
      color: #00ffc6;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s;
    }

    #navbar a:hover {
      color: #37ffd5;
    }

    #navbar span {
      color: #cfcfcf;
      font-size: 18px;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 20px 90px 20px; /* bottom padding for input bar */
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    #sendMsg {
      background-color: #141421;
      display: flex;
      align-items: center;
      padding: 10px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.5);
      position: fixed; /* fixed so mobile keyboard wonâ€™t cover */
      bottom: 0;
      left: 0;
      width: 100%;
      z-index: 100;
    }

    #msgTxt {
      flex: 1;
      height: 45px;
      border-radius: 25px;
      border: none;
      padding: 0 15px;
      background-color: #1e1e2b;
      color: #f5f5f5;
      font-size: 16px;
      outline: none;
    }

    #msgBtn, #imgBtn {
      margin-left: 10px;
      border: none;
      border-radius: 25px;
      background-color: #00ffc6;
      color: #0d0d0d;
      font-weight: bold;
      padding: 10px 18px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #msgBtn:hover, #imgBtn:hover {
      background-color: #37ffd5;
    }

    .outer {
      display: flex;
      margin: 10px 0;
      max-width: 80%;
      position: relative;
    }

    #inner {
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
      line-height: 1.4;
      font-size: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
      position: relative;
    }

    .me {
      background-color: #00ffc6;
      color: #0a0a0a;
      margin-left: auto;
    }

    .notMe {
      background-color: #2f2f6d;
      color: #ffffff;
    }

    .sender-name {
      font-size: 14px;
      font-weight: bold;
      color: #9ae4ff;
      margin-bottom: 4px;
      display: block;
    }

    img.chat-img {
      max-width: 250px; /* limit large images */
      max-height: 250px; /* limit height */
      width: auto;
      height: auto;
      border-radius: 10px;
      margin-top: 8px;
      border: 1px solid #333;
    }

    .delBtn {
      position: absolute;
      top: -10px;
      right: -10px;
      background-color: #141421;
      color: #00ffc6;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 0 6px rgba(0,255,198,0.4);
      transition: background-color 0.3s, transform 0.2s;
    }

    .delBtn:hover {
      background-color: #00ffc6;
      color: #0d0d0d;
      transform: scale(1.1);
    }

    @media (max-width: 768px) {
      #msgTxt {
        font-size: 18px;
      }

      #msgBtn, #imgBtn {
        font-size: 16px;
        padding: 10px 14px;
      }

      .outer {
        max-width: 100%;
      }

      img.chat-img {
        max-width: 70vw; /* responsive on mobile */
        max-height: 70vw;
      }
    }
  </style>
</head>

<body>
  <div id="navbar">
    <a href="index.html">Home</a>
    <span>ðŸ’¬ Chat</span>
    <button id="logoutBtn" style="background:none;border:none;color:#00ffc6;cursor:pointer;font-weight:bold;">Logout</button>
  </div>

  <div id="messages"></div>

  <div id="sendMsg">
    <input type="file" id="imgInput" accept="image/*" style="display:none">
    <button id="imgBtn">ðŸ“·</button>
    <input type="text" id="msgTxt" placeholder="Type a message...">
    <button id="msgBtn">Send</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
    import { getDatabase, ref, set, remove, onChildAdded, onChildRemoved } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-storage.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBpfkkOznjSvyyaEWNsG00huwlA8ObY6j8",
      authDomain: "chat-80d74.firebaseapp.com",
      projectId: "chat-80d74",
      storageBucket: "chat-80d74.appspot.com",
      messagingSenderId: "1085559718603",
      appId: "1:1085559718603:web:c7a9a7f26b1535d080514e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    const msgTxt = document.getElementById("msgTxt");
    const imgInput = document.getElementById("imgInput");
    const imgBtn = document.getElementById("imgBtn");
    const msgBtn = document.getElementById("msgBtn");
    const messages = document.getElementById("messages");
    const logoutBtn = document.getElementById("logoutBtn");

    let currentUser;

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        currentUser = user;
      }
    });

    logoutBtn.onclick = async () => {
      await signOut(auth);
      window.location.href = "index.html";
    };

    // Send text message
    async function sendMessage() {
      if (!msgTxt.value.trim()) return;
      const msg = msgTxt.value.trim();
      const timestamp = Date.now();
      set(ref(db, "messages/" + timestamp), {
        msg,
        sender: currentUser.displayName || currentUser.email,
        uid: currentUser.uid
      });
      msgTxt.value = "";
    }

    msgBtn.onclick = sendMessage;
    msgTxt.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });

    // Image upload
    imgBtn.onclick = () => imgInput.click();
    imgInput.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const timestamp = Date.now();
      const imageRef = sRef(storage, "images/" + timestamp + "_" + file.name);
      await uploadBytes(imageRef, file);
      const url = await getDownloadURL(imageRef);
      set(ref(db, "messages/" + timestamp), {
        img: url,
        sender: currentUser.displayName || currentUser.email,
        uid: currentUser.uid
      });
    };

    // Display messages
    onChildAdded(ref(db, "messages"), (data) => {
      const val = data.val();
      let html = "";

      if (val.uid === currentUser.uid) {
        html = `
          <div class="outer" style="justify-content:flex-end" id="${data.key}">
            <div id="inner" class="me">
              ${val.msg ? val.msg : ""}
              ${val.img ? `<img src="${val.img}" class="chat-img">` : ""}
              <button class="delBtn" onclick="module.dltMsg('${data.key}')">ðŸ—‘</button>
            </div>
          </div>`;
      } else {
        html = `
          <div class="outer" id="${data.key}">
            <div id="inner" class="notMe">
              <span class="sender-name">${val.sender}</span>
              ${val.msg ? val.msg : ""}
              ${val.img ? `<img src="${val.img}" class="chat-img">` : ""}
            </div>
          </div>`;
      }

      messages.innerHTML += html;
      messages.scrollTop = messages.scrollHeight;
    });

    // Delete message
    window.module = {};
    module.dltMsg = function(key) {
      remove(ref(db, "messages/" + key));
    };

    onChildRemoved(ref(db, "messages"), (data) => {
      document.getElementById(data.key)?.remove();
    });

    // Fix for mobile keyboard covering input
    msgTxt.addEventListener("focus", () => {
      setTimeout(() => { messages.scrollTop = messages.scrollHeight; }, 300);
    });
  </script>
</body>
</html>
